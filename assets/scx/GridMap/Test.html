<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>GridMap 测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }

        .container {
            display: flex;
            width: 100%;
            margin: 0 auto;
        }

        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            margin-right: 50px;
        }

        .control-group {
            margin-bottom: 10px;
        }

        label {
            display: inline-block;
            width: 150px;
        }

        .value-display {
            display: inline-block;
            width: 50px;
            text-align: right;
        }

        .canvas-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        canvas {
            border: 1px solid #ddd;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
<div class="container">

    <div class="controls">
        <h1>GridMap 测试</h1>
        <div class="control-group">
            <label>网格大小: </label>
            <input id="cellSize" max="800" min="5" type="range" value="10">
            <span class="value-display" id="cellSizeValue">10</span> px
        </div>
        <div class="control-group">
            <label>圆形半径: </label>
            <input id="radius" max="800" min="1" type="range" value="100">
            <span class="value-display" id="radiusValue">100</span> px
        </div>
        <div id="result">

        </div>
    </div>

    <div class="canvas-container">
        <canvas height="700" id="originalCanvas" width="900"></canvas>
    </div>


</div>

<script type="module">
    import {GridMap} from './GridMap.mjs';

    // DOM 元素
    const cellSizeInput = document.getElementById('cellSize');
    const radiusInput = document.getElementById('radius');

    const cellSizeValue = document.getElementById('cellSizeValue');
    const radiusValue = document.getElementById('radiusValue');

    const result = document.getElementById('result');

    const originalCanvas = document.getElementById('originalCanvas');
    const originalCtx = originalCanvas.getContext('2d');


    // 画布尺寸
    const canvasWidth = originalCanvas.width;
    const canvasHeight = originalCanvas.height;

    //
    /**
     * 全局变量
     * @type {GridMap}
     */
    let gridMap;

    // 更新显示数值
    function updateValues() {
        cellSizeValue.textContent = cellSizeInput.value;
        radiusValue.textContent = radiusInput.value;
    }

    cellSizeInput.addEventListener('input', () => {
        updateValues();
        initGridMap();
        drawGrid();
    });
    radiusInput.addEventListener('input', updateValues);

    // 初始化 GridMap
    function initGridMap() {
        const cellSize = parseInt(cellSizeInput.value);
        gridMap = new GridMap(0, 0, canvasWidth, canvasHeight, cellSize);
    }

    // 绘制网格
    function drawGrid() {
        originalCtx.clearRect(0, 0, canvasWidth, canvasHeight);
        originalCtx.strokeStyle = '#ddd';
        gridMap.forEachCell(cell => {
            originalCtx.strokeRect(cell.worldStartX, cell.worldStartY, gridMap.cellSize, gridMap.cellSize);
        })
    }

    // 绘制圆形并标记格子
    function drawCircle(e) {
        drawGrid();
        const radius = parseInt(radiusInput.value);
        const centerX = e.offsetX;
        const centerY = e.offsetY;

        // 绘制圆形边界
        originalCtx.beginPath();
        originalCtx.arc(centerX, centerY, radius, 0, Math.PI * 2);
        originalCtx.strokeStyle = 'red';
        originalCtx.lineWidth = 2;
        originalCtx.stroke();

        let size = 0;
        let startTime = Date.now();
        // 标记圆形内格子
        gridMap.findCellsInCircleScanLine(centerX, centerY, radius, (cell) => {
            // debugger
            size += 1;

            // debugger
            originalCtx.fillStyle = 'rgba(255,0,0,0.3)';
            originalCtx.fillRect(cell.worldStartX, cell.worldStartY, gridMap.cellSize, gridMap.cellSize);
        });
        result.innerHTML = "覆盖格子数 " + size + "\r\n耗时: " + (Date.now() - startTime);
    }

    // 事件绑定
    originalCanvas.addEventListener('mousemove', drawCircle);

    // 初始化
    updateValues();
    initGridMap();
    drawGrid();

</script>

</body>
</html>